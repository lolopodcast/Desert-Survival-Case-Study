import React, { useState, useEffect, useRef } from 'react';
import { Moon, Sun, Languages, Volume2, VolumeX, Check, Info, FileText, CheckSquare, Square, CheckCircle2, Circle, AlertCircle, Download } from 'lucide-react';

// --- Data & Translations ---
const translations = {
  zh: {
    title: "沙漠求生 (Desert Survival) 案例分析",
    subtitle: "危機決策與團隊共識工作坊",
    smmcAbbr: "[SMMC]",
    smmcFull: "國際策略管理",
    version: "版本: 2026.02.23",
    copyright: "© 2026 Desert Survival Exercise. 版權所有。",
    langToggle: "English",
    themeToggle: "切換主題",
    voicePlay: "語音導覽",
    voiceStop: "停止語音",
    exportYouCsv: "匯出個人(Y)決策 CSV",
    exportTeamCsv: "匯出團隊(T)決策 CSV",
    
    // Situation
    situationTitle: "I. 狀況說明 (Situation Overview)",
    situationText: "8月8日上午11:45，你與其他四位同伴，穿著夏天的休閒服，一起站在美國西南部 Sonora 沙漠的一處地方，茫然地凝視著20分鐘前還搭乘的雙引擎輕型飛機殘骸，以及正副駕駛的遺體。雖然大夥在先前的迫降行動中受到不小的驚嚇，但存活的人大體上都安然無恙，並沒有大的創傷。\n\n其實，會發生這樣的不幸，實在令人意想不到。原本大夥可以安穩地搭乘民航機從 Acapulco 回到 Prescott 的家中，但就在要離開 Acapulco 時，由於天氣太好，大夥臨時決定搭乘這架巡航半徑1,400浬，飛行速度185節，且空間足夠容納我們一行人的雙引擎飛機，慢慢飛回家鄉。\n\n從 Acapulco 起飛後，大約在10點過後飛機降落在墨西哥的Hermosillo 補充油料，10:30再度起飛。10:45 時你聽到駕駛員經由Nogales 聯絡 Tucson 市的無線電，要求通過美墨邊界的ADI區，駕駛員告訴大家，大約正午過後即可到達 Prescott，然後便把(交流)發電機切掉。\n\n就在飛越過 Nogales 後沒多久，飛機的右翼引擎突然熄火，15分鐘後左翼引擎同樣也熄火，使得無線電與其他電子設備也跟著失靈。隨著飛機的下降，駕駛員警告大家準備緊急迫降，他同時也提到我們現在的位置，大約是在向西或西北偏離航道30浬的地方。\n\n接著，很不幸的，當飛機迫降時，機輪撞到地面，導致飛機打轉，右機翼撞到岩石而嚴重損壞，油箱因而撞裂，機尾也完全斷裂，其餘殘骸則與左翼混在一起。當飛機靜止時，大夥兒立即反應要由機尾斷裂處逃生，此時空氣中充滿了濃厚的汽油味，而正副駕駛則嚴重受傷，且被座艙的機件卡住而動彈不得，於是大夥只好迅速地在汽油被燃爆之前逃離機骸。在大火中，可用來發送訊息的無線電發報機被燒壞了，而機尾部份則被彈到50碼以外的地方。\n\n發生災難的現場是一片佈滿石頭的沙漠，草叢裡有不少多次的Cholla仙人掌，以及少數 Saguro 仙人掌。根據失事前的氣象報告顯示此時的溫度高達110°F (約43.3°C)，而地面溫度更高達130°F (約54.4°C)。眺望山脈仍在遠方，而大夥兒回憶起最後一次看到文明世界的公路路標，似乎是在失事前的15分鐘。於是，所有存活夥伴收拾起驚嚇的心情，分頭在現場尋找行李及散置的物品。總共找到些許的現金，2條菸，1個打火機，3串鑰匙，以及清單所列的16項物品。\n\n恭喜你逃過了這場空難，但是你將面臨另一項的挑戰——如何安全地逃離這片沙漠。",
    
    // Instructions
    instructionTitle: "II. 決策指引 (Instructions)",
    instructions: [
      "自下方的求生計劃，先自行作答，不要與他人討論，並將答案填入「個人(Y)」欄位。",
      "以小組討論的方式，凝聚共識，將團隊的最終決定填入「團隊(T)」欄位。",
      "在小組尚未討論前，您可以無限制地更動答案；一旦開始進行小組討論，請勿再更動個人答案。",
      "求生計劃包括三大類：A.主要需克服的問題，B.基本求生策略，C.物品選擇與運用。"
    ],

    // Part A
    partATitle: "A. 主要需克服的問題 (Key Challenges)",
    partADesc: "請針對以下問題，選出您認為最關鍵的 4 項：",
    partAOptions: [
      { id: 'a', text: "取得更多的水" },
      { id: 'b', text: "取得更多的食物" },
      { id: 'c', text: "決定誰去爭取救援" },
      { id: 'd', text: "計劃如何飛航" },
      { id: 'e', text: "建構訊號以利救援人員辨識" },
      { id: 'f', text: "在夜晚時保持體溫" },
      { id: 'g', text: "減少身體水分流失" },
      { id: 'h', text: "保持安靜與情緒穩定" }
    ],

    // Part B
    partBTitle: "B. 基本求生策略 (Basic Strategy)",
    partBDesc: "請從下列選項，決定 1 項最有利於你們的求生策略：",
    partBOptions: [
      { id: 'a', text: "開始尋找方向，走向公路" },
      { id: 'b', text: "等待在失事現場，直到天黑後才開始往外走" },
      { id: 'c', text: "立即派遣一二人出去尋求救援" },
      { id: 'd', text: "待在失事現場，等待救援" },
      { id: 'e', text: "待在失事地點二天後，再開始往外走" },
      { id: 'f', text: "待在失事地點四天後，再開始往外走" }
    ],

    // Part C
    partCTitle: "C. 物品選擇與運用 (Item Utilization)",
    partCDesc: "1. 將物品依重要性分為4群(填入 1, 2, 3, 4)。 2. 針對各物品選出最有利的運用方式(a, b, c, d)。",
    groupLegend: "1: 絕對需要 | 2: 顯著貢獻 | 3: 延長存活/非絕對 | 4: 無用甚至危害",
    tableHeaders: ["物品 (Items)", "重要性分群", "最佳運用方式", "個人 (Y)", "團隊 (T)"],
    items: [
      { id: 1, name: "(1) 飛機用的羅盤", options: [{v:'a', t:'將其內含之液體取出飲用'}, {v:'b', t:'將其發亮部位輔助打信號'}, {v:'c', t:'用其中透鏡取火'}, {v:'d', t:'配合地圖,找通往文明世界之路'}] },
      { id: 2, name: "(2) 5條白色的絲巾", options: [{v:'a', t:'當作繃帶用'}, {v:'b', t:'用來攜帶補給品'}, {v:'c', t:'用來遮蔽頭部與臉部'}] },
      { id: 3, name: "(3) 3瓶白蘭地", options: [{v:'a', t:'喝一杯放鬆心情'}, {v:'b', t:'倒在身上冷卻體溫'}, {v:'c', t:'喝一些減緩脫水'}, {v:'d', t:'丟棄'}] },
      { id: 4, name: "(4) 點心盒子", options: [{v:'a', t:'立即分吃以充飢'}, {v:'b', t:'定額配給兩天'}, {v:'c', t:'當飢餓時吃小量充飢'}, {v:'d', t:'丟棄'}] },
      { id: 5, name: "(5) 化妝盒", options: [{v:'a', t:'將粉撲在臉上及頭髮上'}, {v:'b', t:'把香水拿來喝'}, {v:'c', t:'用盒中的化妝鏡打信號'}, {v:'d', t:'口紅塗在衣服上'}] },
      { id: 6, name: "(6) 塑膠水壺", options: [{v:'a', t:'交給帶頭的人'}, {v:'b', t:'定額配給兩天'}, {v:'c', t:'需要時小口啜飲'}, {v:'d', t:'每人分1卡脫,當需要時喝'}] },
      { id: 7, name: "(7) 2卡脫的機油", options: [{v:'a', t:'燃燒以作為信號'}, {v:'b', t:'倒在身上以為保護'}, {v:'c', t:'倒在地上使走過留下足跡線索'}, {v:'d', t:'丟棄'}] },
      { id: 8, name: "(8) 2支20ga散彈獵槍", options: [{v:'a', t:'組成狩獵小組用'}, {v:'b', t:'當作多用途的工具(如挖,...等)'}, {v:'c', t:'作為打信號用'}, {v:'d', t:'將火藥用於製造訊號火焰,槍本身則掩埋'}] },
      { id: 9, name: "(9) 彎刀(南美人用)", options: [{v:'a', t:'交給帶頭的人'}, {v:'b', t:'交給狩獵小組'}, {v:'c', t:'用來砍仙人掌'}, {v:'d', t:'丟棄此一危險物'}] },
      { id: 10, name: "(10) 20個黑色垃圾袋", options: [{v:'a', t:'在地上排成 SOS 字樣'}, {v:'b', t:'作太陽能蒸餾器'}, {v:'c', t:'攜帶補給品'}, {v:'d', t:'穿在身上'}] },
      { id: 11, name: "(11) 大型海灘傘", options: [{v:'a', t:'遮蓋正副駕駛屍體'}, {v:'b', t:'利用其骨架與布料作背包'}, {v:'c', t:'撐直以為遮蔽'}, {v:'d', t:'撐開以為信號'}] },
      { id: 12, name: "(12) 5件輕便外套", options: [{v:'a', t:'立即穿上'}, {v:'b', t:'晚上再穿'}, {v:'c', t:'與地隔絕之用'}, {v:'d', t:'將五件合起來作為遮蔽物'}] },
      { id: 13, name: "(13) FM收音機", options: [{v:'a', t:'傳送 SOS 訊號'}, {v:'b', t:'利用其中之電瓶液起火'}, {v:'c', t:'收聽廣播'}, {v:'d', t:'丟棄'}] },
      { id: 14, name: "(14) 4磅墨西哥精鹽", options: [{v:'a', t:'平分,盡量攝食'}, {v:'b', t:'與水同時配額分配'}, {v:'c', t:'每日取用3匙份'}, {v:'d', t:'丟棄'}] },
      { id: 15, name: "(15) 地圖封套", options: [{v:'a', t:'將地圖點火作信號'}, {v:'b', t:'將地圖點火取暖'}, {v:'c', t:'利用地圖作火炬以驅散動物'}, {v:'d', t:'利用區域地圖尋找出路'}] },
      { id: 16, name: "(16) 急救包", options: [{v:'a', t:'用殺菌劑敷刀傷及抓傷處'}, {v:'b', t:'製作紗布頭巾'}, {v:'c', t:'用紗布輔助遮蔽'}] }
    ],
    you: "個人 (Y)",
    team: "團隊 (T)",
    selected: "已選擇"
  },
  en: {
    title: "Desert Survival Case Study",
    subtitle: "Crisis Decision-Making & Team Consensus Workshop",
    smmcAbbr: "[SMMC]",
    smmcFull: "Strategic Management of Multinational Corporations",
    version: "Version: 2026.02.23",
    copyright: "© 2026 Desert Survival Exercise. All rights reserved.",
    langToggle: "中文",
    themeToggle: "Toggle Theme",
    voicePlay: "Voice Guide",
    voiceStop: "Stop Voice",
    exportYouCsv: "Export Individual (Y) CSV",
    exportTeamCsv: "Export Team (T) CSV",
    
    // Situation
    situationTitle: "I. Situation Overview",
    situationText: "It is 11:45 AM on August 8. You and four companions, dressed in casual summer wear, are standing in the Sonora Desert in the southwestern U.S., staring blankly at the wreckage of a twin-engine light aircraft you were in 20 minutes ago, along with the bodies of the pilot and co-pilot. Though shaken by the crash landing, the survivors are largely unhurt without major injuries.\n\nThis misfortune was entirely unexpected. You could have safely taken a commercial flight from Acapulco back to Prescott. However, due to excellent weather, the group decided to take this twin-engine plane—capable of a 1,400-nautical-mile range, 185-knot speed, and spacious enough for everyone—to fly home leisurely.\n\nAfter taking off from Acapulco, the plane landed in Hermosillo, Mexico, for refueling around 10:00 AM, and took off again at 10:30 AM. At 10:45 AM, you heard the pilot contact Tucson via radio near Nogales, requesting to cross the ADI zone. He announced you'd reach Prescott shortly after noon and then turned off the alternator.\n\nShortly after passing Nogales, the right engine suddenly failed, followed by the left engine 15 minutes later, knocking out the radio and electrical equipment. As the plane descended, the pilot warned of an emergency landing and noted you were approximately 30 miles west or northwest off course.\n\nUnfortunately, during the landing, the wheels struck the ground, causing the plane to spin. The right wing hit a rock, severely damaging it and rupturing the fuel tank; the tail completely snapped off. As the plane came to a halt, the group immediately escaped through the broken tail. The air was thick with the smell of gasoline. The pilots were severely injured and pinned by the cockpit wreckage. Before the gasoline exploded, the group fled the wreckage. In the fire, the radio transmitter was destroyed, and the tail section was thrown 50 yards away.\n\nThe crash site is a rocky desert, dotted with Cholla and a few Saguaro cacti. The pre-crash weather report indicated temperatures of 110°F (43.3°C), with ground temperatures reaching 130°F (54.4°C). Mountains are visible in the distance. The group recalls seeing the last highway sign indicating civilization about 15 minutes before the crash. Gathering your wits, the survivors scoured the area and found some cash, 2 cartons of cigarettes, 1 lighter, 3 sets of keys, and the 16 items listed below.\n\nCongratulations on surviving the crash. Now you face a new challenge: safely escaping this desert.",
    
    // Instructions
    instructionTitle: "II. Instructions",
    instructions: [
      "First, answer the survival plan below individually without discussing it with others. Fill your answers in the 'You (Y)' column.",
      "Then, through group discussion, reach a consensus and fill the team's answers in the 'Team (T)' column.",
      "You can change your individual answers freely before the discussion starts; once the discussion begins, please do not alter your individual answers.",
      "The plan includes three categories: A. Key Challenges, B. Basic Strategy, C. Item Utilization."
    ],

    // Part A
    partATitle: "A. Key Challenges",
    partADesc: "Select the 4 most critical challenges from the list below:",
    partAOptions: [
      { id: 'a', text: "Get more water" },
      { id: 'b', text: "Get more food" },
      { id: 'c', text: "Decide who goes for help" },
      { id: 'd', text: "Plan navigation" },
      { id: 'e', text: "Build signals for rescue" },
      { id: 'f', text: "Keep warm at night" },
      { id: 'g', text: "Reduce body water loss" },
      { id: 'h', text: "Keep quiet and emotionally stable" }
    ],

    // Part B
    partBTitle: "B. Basic Strategy",
    partBDesc: "Choose the 1 most advantageous strategy from the options below:",
    partBOptions: [
      { id: 'a', text: "Start navigating and walk to the highway" },
      { id: 'b', text: "Wait at the crash site until dark, then walk" },
      { id: 'c', text: "Immediately dispatch 1-2 people for help" },
      { id: 'd', text: "Stay at the crash site and wait for rescue" },
      { id: 'e', text: "Stay at the site for 2 days, then start walking" },
      { id: 'f', text: "Stay at the site for 4 days, then start walking" }
    ],

    // Part C
    partCTitle: "C. Item Selection & Utilization",
    partCDesc: "1. Rank items into 4 groups (1, 2, 3, 4). 2. Choose the best usage (a, b, c, d) for each item.",
    groupLegend: "1: Essential | 2: Significant | 3: Helpful/Extend survival | 4: Useless/Harmful",
    tableHeaders: ["Items", "Importance Rank", "Best Usage", "You (Y)", "Team (T)"],
    items: [
      { id: 1, name: "(1) Aircraft Compass", options: [{v:'a', t:'Drink the liquid inside'}, {v:'b', t:'Use shiny parts for signaling'}, {v:'c', t:'Use lens to start a fire'}, {v:'d', t:'Use with map to find civilization'}] },
      { id: 2, name: "(2) 5 White Silk Scarves", options: [{v:'a', t:'Use as bandages'}, {v:'b', t:'Use to carry supplies'}, {v:'c', t:'Use to cover head and face'}] },
      { id: 3, name: "(3) 3 Bottles of Brandy", options: [{v:'a', t:'Drink to relax'}, {v:'b', t:'Pour on body to cool down'}, {v:'c', t:'Drink to slow dehydration'}, {v:'d', t:'Discard'}] },
      { id: 4, name: "(4) Snack Box", options: [{v:'a', t:'Eat immediately to relieve hunger'}, {v:'b', t:'Ration for two days'}, {v:'c', t:'Eat small amounts when hungry'}, {v:'d', t:'Discard'}] },
      { id: 5, name: "(5) Cosmetic Case", options: [{v:'a', t:'Apply powder to face/hair'}, {v:'b', t:'Drink the perfume'}, {v:'c', t:'Use mirror for signaling'}, {v:'d', t:'Apply lipstick on clothes'}] },
      { id: 6, name: "(6) Plastic Water Bottle", options: [{v:'a', t:'Give to the leader'}, {v:'b', t:'Ration for two days'}, {v:'c', t:'Sip when necessary'}, {v:'d', t:'Distribute equally, drink when needed'}] },
      { id: 7, name: "(7) 2 Qts Engine Oil", options: [{v:'a', t:'Burn for signaling'}, {v:'b', t:'Pour on body for protection'}, {v:'c', t:'Pour on ground to track footprints'}, {v:'d', t:'Discard'}] },
      { id: 8, name: "(8) 2 20ga Shotguns", options: [{v:'a', t:'Form a hunting party'}, {v:'b', t:'Use as multi-tools (e.g., digging)'}, {v:'c', t:'Use for signaling'}, {v:'d', t:'Use powder for fire, bury the guns'}] },
      { id: 9, name: "(9) Machete", options: [{v:'a', t:'Give to the leader'}, {v:'b', t:'Give to the hunting party'}, {v:'c', t:'Use to chop cactus'}, {v:'d', t:'Discard this dangerous item'}] },
      { id: 10, name: "(10) 20 Black Trash Bags", options: [{v:'a', t:'Arrange as SOS on the ground'}, {v:'b', t:'Make solar stills'}, {v:'c', t:'Carry supplies'}, {v:'d', t:'Wear them'}] },
      { id: 11, name: "(11) Large Beach Umbrella", options: [{v:'a', t:'Cover pilots bodies'}, {v:'b', t:'Use frame and fabric for a backpack'}, {v:'c', t:'Stand straight for shade'}, {v:'d', t:'Open for signaling'}] },
      { id: 12, name: "(12) 5 Light Jackets", options: [{v:'a', t:'Wear immediately'}, {v:'b', t:'Wear at night'}, {v:'c', t:'Use to insulate from the ground'}, {v:'d', t:'Combine all five to make a shelter'}] },
      { id: 13, name: "(13) FM Radio", options: [{v:'a', t:'Transmit SOS signals'}, {v:'b', t:'Use battery fluid to start fire'}, {v:'c', t:'Listen to broadcasts'}, {v:'d', t:'Discard'}] },
      { id: 14, name: "(14) 4 lbs Mexican Salt", options: [{v:'a', t:'Divide equally, consume as much as possible'}, {v:'b', t:'Ration simultaneously with water'}, {v:'c', t:'Take 3 spoonfuls daily'}, {v:'d', t:'Discard'}] },
      { id: 15, name: "(15) Map Case", options: [{v:'a', t:'Ignite map for signaling'}, {v:'b', t:'Ignite map for warmth'}, {v:'c', t:'Use map as a torch to ward off animals'}, {v:'d', t:'Use map to find a way out'}] },
      { id: 16, name: "(16) First Aid Kit", options: [{v:'a', t:'Apply antiseptic to cuts and scratches'}, {v:'b', t:'Make gauze bandanas'}, {v:'c', t:'Use gauze for additional shade'}] }
    ],
    you: "You (Y)",
    team: "Team (T)",
    selected: "Selected"
  }
};

const App = () => {
  const [lang, setLang] = useState('zh');
  const [theme, setTheme] = useState('light');
  const [isSpeaking, setIsSpeaking] = useState(false);
  
  const [answersA_Y, setAnswersA_Y] = useState([]);
  const [answersA_T, setAnswersA_T] = useState([]);
  const [answerB_Y, setAnswerB_Y] = useState('');
  const [answerB_T, setAnswerB_T] = useState('');
  const [answersC_Y, setAnswersC_Y] = useState({});
  const [answersC_T, setAnswersC_T] = useState({});

  const t = translations[lang];

  // Pre-load voices on mount to ensure they are available
  useEffect(() => {
    window.speechSynthesis.getVoices();
  }, []);

  // Theme Toggle Effect
  useEffect(() => {
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }, [theme]);

  // Voice Guide
  const handleVoice = () => {
    if (isSpeaking) {
      window.speechSynthesis.cancel();
      setIsSpeaking(false);
      return;
    }
    const textToSpeak = t.situationText;
    const utterance = new SpeechSynthesisUtterance(textToSpeak);
    
    // Set specific voices based on language
    const voices = window.speechSynthesis.getVoices();
    if (lang === 'zh') {
      utterance.lang = 'zh-TW';
      // Search for Taiwan-Yating, fallback to any zh-TW
      const yatingVoice = voices.find(v => v.lang.includes('zh-TW') && (v.name.includes('Yating') || v.name.includes('雅婷')));
      if (yatingVoice) {
        utterance.voice = yatingVoice;
      } else {
        const defaultTw = voices.find(v => v.lang.includes('zh-TW'));
        if (defaultTw) utterance.voice = defaultTw;
      }
    } else {
      utterance.lang = 'en-GB';
      // Search for British-Male, fallback to any en-GB
      const ukMaleVoice = voices.find(v => (v.lang === 'en-GB' || v.lang === 'en-UK') && (v.name.includes('Male') || v.name.includes('George') || v.name.includes('Arthur')));
      if (ukMaleVoice) {
        utterance.voice = ukMaleVoice;
      } else {
        const defaultUk = voices.find(v => v.lang === 'en-GB' || v.lang === 'en-UK');
        if (defaultUk) utterance.voice = defaultUk;
      }
    }

    utterance.rate = 0.95;
    utterance.onend = () => setIsSpeaking(false);
    window.speechSynthesis.speak(utterance);
    setIsSpeaking(true);
  };

  // Cleanup speech on unmount or language change
  useEffect(() => {
    window.speechSynthesis.cancel();
    setIsSpeaking(false);
  }, [lang]);

  // Handlers for Part A
  const togglePartA = (id, type) => {
    const currentList = type === 'Y' ? answersA_Y : answersA_T;
    const setter = type === 'Y' ? setAnswersA_Y : setAnswersA_T;
    
    if (currentList.includes(id)) {
      setter(currentList.filter(item => item !== id));
    } else {
      if (currentList.length < 4) {
        setter([...currentList, id]);
      }
    }
  };

  // Handlers for Part C
  const updatePartC = (itemId, type, field, value) => {
    const current = type === 'Y' ? answersC_Y : answersC_T;
    const setter = type === 'Y' ? setAnswersC_Y : setAnswersC_T;
    
    setter({
      ...current,
      [itemId]: { ...current[itemId], [field]: value }
    });
  };

  // CSV Export Logic
  const handleExportCSV = (type) => {
    let csvContent = '\uFEFF'; // UTF-8 BOM for Excel compatibility
    const title = type === 'Y' ? t.you : t.team;
    
    // Title
    csvContent += `"${t.title} - ${title}"\n\n`;
    
    // Part A
    csvContent += `"${t.partATitle}"\n`;
    const ansA = type === 'Y' ? answersA_Y : answersA_T;
    ansA.forEach(id => {
      const opt = t.partAOptions.find(o => o.id === id);
      csvContent += `"${opt.id}","${opt.text}"\n`;
    });
    csvContent += `\n`;

    // Part B
    csvContent += `"${t.partBTitle}"\n`;
    const ansB = type === 'Y' ? answerB_Y : answerB_T;
    if (ansB) {
      const optB = t.partBOptions.find(o => o.id === ansB);
      csvContent += `"${optB.id}","${optB.text}"\n`;
    }
    csvContent += `\n`;

    // Part C
    csvContent += `"${t.partCTitle}"\n`;
    csvContent += `"${t.tableHeaders[0]}","${t.tableHeaders[1]}","${t.tableHeaders[2]}"\n`;
    const ansC = type === 'Y' ? answersC_Y : answersC_T;
    t.items.forEach(item => {
      const group = ansC[item.id]?.group || '';
      const usage = ansC[item.id]?.usage || '';
      csvContent += `"${item.name}","${group}","${usage}"\n`;
    });

    // Create and trigger download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `Desert_Survival_${type}_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <div className={`min-h-screen font-sans transition-colors duration-300 ${theme === 'dark' ? 'bg-[#0f172a] text-gray-200' : 'bg-[#f8f9fa] text-gray-800'}`}>
      
      {/* Top Navigation / BCG Style Header */}
      <header className={`sticky top-0 z-50 border-t-[6px] border-[#005A3C] shadow-sm ${theme === 'dark' ? 'bg-[#1e293b]' : 'bg-white'}`}>
        <div className="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
          <div className="flex flex-col">
            <button 
              onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
              className="text-left group cursor-pointer mb-1.5"
              title="回到頁首 (Back to top)"
            >
              <div className="flex items-center gap-2">
                <span className="font-bold text-[#005A3C] bg-emerald-100 dark:bg-[#005A3C]/20 px-1.5 py-0.5 rounded text-xs group-hover:bg-emerald-200 dark:group-hover:bg-[#005A3C]/40 transition-colors">
                  {t.smmcAbbr}
                </span>
                <span className="text-xs md:text-sm font-medium text-gray-500 dark:text-gray-400 group-hover:text-[#005A3C] dark:group-hover:text-emerald-400 transition-colors">
                  {t.smmcFull}
                </span>
              </div>
            </button>
            <h1 className="text-xl md:text-2xl font-serif font-bold text-[#005A3C] tracking-tight">{t.title}</h1>
            <p className={`text-xs md:text-sm mt-1 ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>{t.subtitle}</p>
          </div>
          <div className="flex gap-4">
            <button onClick={() => setLang(lang === 'zh' ? 'en' : 'zh')} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition flex items-center gap-2 text-sm font-medium">
              <Languages size={18} /> <span className="hidden md:inline">{t.langToggle}</span>
            </button>
            <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              {theme === 'dark' ? <Sun size={18} /> : <Moon size={18} />}
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto px-4 md:px-6 py-8 space-y-10">
        
        {/* Section: Situation Overview */}
        <section className={`p-8 rounded-xl shadow-sm border-l-4 border-[#005A3C] ${theme === 'dark' ? 'bg-[#1e293b]' : 'bg-white'}`}>
          <div className="flex justify-between items-start mb-6">
            <h2 className="text-2xl font-serif font-bold text-[#005A3C] flex items-center gap-2">
              <Info className="text-[#005A3C]" /> {t.situationTitle}
            </h2>
            <button 
              onClick={handleVoice}
              className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition ${isSpeaking ? 'bg-red-50 text-red-600 border border-red-200 dark:bg-red-900/30 dark:text-red-400' : 'bg-emerald-50 text-[#005A3C] border border-emerald-200 hover:bg-emerald-100 dark:bg-[#005A3C]/20 dark:text-emerald-400'}`}
            >
              {isSpeaking ? <VolumeX size={16} /> : <Volume2 size={16} />}
              {isSpeaking ? t.voiceStop : t.voicePlay}
            </button>
          </div>
          <div className="space-y-4 text-justify leading-relaxed">
            {t.situationText.split('\n\n').map((para, idx) => (
              <p key={idx} className={theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}>{para}</p>
            ))}
          </div>
        </section>

        {/* Section: Instructions */}
        <section className={`p-6 rounded-xl border ${theme === 'dark' ? 'bg-[#1e293b] border-gray-700' : 'bg-gray-50 border-gray-200'}`}>
          <h3 className="text-lg font-bold mb-4 flex items-center gap-2 font-serif text-[#005A3C]">
            <FileText size={20} /> {t.instructionTitle}
          </h3>
          <ul className="list-decimal pl-6 space-y-2 text-sm md:text-base">
            {t.instructions.map((inst, idx) => (
              <li key={idx} className={theme === 'dark' ? 'text-gray-300' : 'text-gray-600'}>{inst}</li>
            ))}
          </ul>
        </section>

        {/* Form Container */}
        <div className="space-y-10">
          
          {/* Part A */}
          <section className={`p-6 md:p-8 rounded-xl shadow-sm ${theme === 'dark' ? 'bg-[#1e293b]' : 'bg-white'}`}>
            <h2 className="text-xl font-serif font-bold text-[#005A3C] mb-2">{t.partATitle}</h2>
            <p className="text-sm text-gray-500 dark:text-gray-400 mb-6 flex items-center gap-2">
              <AlertCircle size={16} /> {t.partADesc}
            </p>
            
            <div className="grid md:grid-cols-2 gap-8">
              {/* You Column */}
              <div className={`p-6 rounded-lg border ${theme === 'dark' ? 'bg-[#0f172a] border-gray-700' : 'bg-gray-50 border-gray-200'}`}>
                <div className="flex justify-between items-center mb-4">
                  <h4 className="font-bold border-b-2 border-[#005A3C] pb-1">{t.you}</h4>
                  <span className={`text-sm px-2 py-1 rounded ${answersA_Y.length === 4 ? 'bg-[#005A3C] text-white' : 'bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300'}`}>{t.selected}: {answersA_Y.length}/4</span>
                </div>
                <div className="space-y-3">
                  {t.partAOptions.map(opt => (
                    <label key={`y-${opt.id}`} className={`flex items-start gap-3 p-3 rounded-md cursor-pointer transition ${answersA_Y.includes(opt.id) ? 'bg-emerald-50 border-emerald-200 dark:bg-emerald-900/20 border dark:border-emerald-800' : 'hover:bg-gray-100 dark:hover:bg-gray-800 border border-transparent'}`}>
                      <input type="checkbox" className="hidden" checked={answersA_Y.includes(opt.id)} onChange={() => togglePartA(opt.id, 'Y')} />
                      {answersA_Y.includes(opt.id) ? <CheckSquare className="text-[#005A3C] mt-0.5 shrink-0" size={18}/> : <Square className="text-gray-400 mt-0.5 shrink-0" size={18}/>}
                      <span className={answersA_Y.includes(opt.id) ? 'font-medium text-[#005A3C] dark:text-emerald-400' : ''}>{opt.id}. {opt.text}</span>
                    </label>
                  ))}
                </div>
              </div>

              {/* Team Column */}
              <div className={`p-6 rounded-lg border ${theme === 'dark' ? 'bg-[#0f172a] border-gray-700' : 'bg-gray-50 border-gray-200'}`}>
                <div className="flex justify-between items-center mb-4">
                  <h4 className="font-bold border-b-2 border-[#005A3C] pb-1">{t.team}</h4>
                  <span className={`text-sm px-2 py-1 rounded ${answersA_T.length === 4 ? 'bg-[#005A3C] text-white' : 'bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300'}`}>{t.selected}: {answersA_T.length}/4</span>
                </div>
                <div className="space-y-3">
                  {t.partAOptions.map(opt => (
                    <label key={`t-${opt.id}`} className={`flex items-start gap-3 p-3 rounded-md cursor-pointer transition ${answersA_T.includes(opt.id) ? 'bg-emerald-50 border-emerald-200 dark:bg-emerald-900/20 border dark:border-emerald-800' : 'hover:bg-gray-100 dark:hover:bg-gray-800 border border-transparent'}`}>
                      <input type="checkbox" className="hidden" checked={answersA_T.includes(opt.id)} onChange={() => togglePartA(opt.id, 'T')} />
                      {answersA_T.includes(opt.id) ? <CheckSquare className="text-[#005A3C] mt-0.5 shrink-0" size={18}/> : <Square className="text-gray-400 mt-0.5 shrink-0" size={18}/>}
                      <span className={answersA_T.includes(opt.id) ? 'font-medium text-[#005A3C] dark:text-emerald-400' : ''}>{opt.id}. {opt.text}</span>
                    </label>
                  ))}
                </div>
              </div>
            </div>
          </section>

          {/* Part B */}
          <section className={`p-6 md:p-8 rounded-xl shadow-sm ${theme === 'dark' ? 'bg-[#1e293b]' : 'bg-white'}`}>
            <h2 className="text-xl font-serif font-bold text-[#005A3C] mb-2">{t.partBTitle}</h2>
            <p className="text-sm text-gray-500 dark:text-gray-400 mb-6 flex items-center gap-2">
              <AlertCircle size={16} /> {t.partBDesc}
            </p>

            <div className="grid md:grid-cols-2 gap-8">
              {/* You Column */}
              <div className={`p-6 rounded-lg border ${theme === 'dark' ? 'bg-[#0f172a] border-gray-700' : 'bg-gray-50 border-gray-200'}`}>
                <h4 className="font-bold border-b-2 border-[#005A3C] pb-1 mb-4 inline-block">{t.you}</h4>
                <div className="space-y-3">
                  {t.partBOptions.map(opt => (
                    <label key={`y-${opt.id}`} className={`flex items-start gap-3 p-3 rounded-md cursor-pointer transition ${answerB_Y === opt.id ? 'bg-emerald-50 border-emerald-200 dark:bg-emerald-900/20 border dark:border-emerald-800' : 'hover:bg-gray-100 dark:hover:bg-gray-800 border border-transparent'}`}>
                      <input type="radio" name="partBY" className="hidden" checked={answerB_Y === opt.id} onChange={() => setAnswerB_Y(opt.id)} />
                      {answerB_Y === opt.id ? <CheckCircle2 className="text-[#005A3C] mt-0.5 shrink-0" size={18}/> : <Circle className="text-gray-400 mt-0.5 shrink-0" size={18}/>}
                      <span className={answerB_Y === opt.id ? 'font-medium text-[#005A3C] dark:text-emerald-400' : ''}>{opt.id}. {opt.text}</span>
                    </label>
                  ))}
                </div>
              </div>

              {/* Team Column */}
              <div className={`p-6 rounded-lg border ${theme === 'dark' ? 'bg-[#0f172a] border-gray-700' : 'bg-gray-50 border-gray-200'}`}>
                <h4 className="font-bold border-b-2 border-[#005A3C] pb-1 mb-4 inline-block">{t.team}</h4>
                <div className="space-y-3">
                  {t.partBOptions.map(opt => (
                    <label key={`t-${opt.id}`} className={`flex items-start gap-3 p-3 rounded-md cursor-pointer transition ${answerB_T === opt.id ? 'bg-emerald-50 border-emerald-200 dark:bg-emerald-900/20 border dark:border-emerald-800' : 'hover:bg-gray-100 dark:hover:bg-gray-800 border border-transparent'}`}>
                      <input type="radio" name="partBT" className="hidden" checked={answerB_T === opt.id} onChange={() => setAnswerB_T(opt.id)} />
                      {answerB_T === opt.id ? <CheckCircle2 className="text-[#005A3C] mt-0.5 shrink-0" size={18}/> : <Circle className="text-gray-400 mt-0.5 shrink-0" size={18}/>}
                      <span className={answerB_T === opt.id ? 'font-medium text-[#005A3C] dark:text-emerald-400' : ''}>{opt.id}. {opt.text}</span>
                    </label>
                  ))}
                </div>
              </div>
            </div>
          </section>

          {/* Part C */}
          <section className={`p-6 md:p-8 rounded-xl shadow-sm overflow-hidden ${theme === 'dark' ? 'bg-[#1e293b]' : 'bg-white'}`}>
            <h2 className="text-xl font-serif font-bold text-[#005A3C] mb-2">{t.partCTitle}</h2>
            <div className="mb-6 space-y-2">
              <p className="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-2">
                <AlertCircle size={16} /> {t.partCDesc}
              </p>
              <div className={`text-xs p-3 rounded font-mono ${theme === 'dark' ? 'bg-gray-800 text-gray-300' : 'bg-emerald-50 text-emerald-800'}`}>
                {t.groupLegend}
              </div>
            </div>

            <div className="overflow-x-auto">
              <table className="w-full text-left border-collapse text-sm">
                <thead>
                  <tr className="bg-[#005A3C] text-white">
                    <th className="p-3 font-semibold w-1/4 rounded-tl-md">{t.tableHeaders[0]}</th>
                    <th className="p-3 font-semibold text-center border-l border-emerald-700">分類</th>
                    <th className="p-3 font-semibold w-2/5 border-l border-emerald-700">{t.tableHeaders[2]}</th>
                    <th className="p-3 font-semibold text-center border-l border-emerald-700 w-16">{t.tableHeaders[3]}</th>
                    <th className="p-3 font-semibold text-center border-l border-emerald-700 w-16 rounded-tr-md">{t.tableHeaders[4]}</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200 dark:divide-gray-700 border border-t-0 border-gray-200 dark:border-gray-700">
                  {t.items.map((item, index) => (
                    <tr key={item.id} className={`transition-colors hover:bg-emerald-50/50 dark:hover:bg-emerald-900/10 ${index % 2 === 0 ? (theme === 'dark' ? 'bg-[#1e293b]' : 'bg-white') : (theme === 'dark' ? 'bg-[#0f172a]/50' : 'bg-gray-50')}`}>
                      <td className="p-3 font-medium border-r dark:border-gray-700">{item.name}</td>
                      
                      {/* Classification (1,2,3,4) */}
                      <td className="p-3 border-r dark:border-gray-700 align-top">
                        <div className="flex gap-4 justify-center">
                          <div className="flex flex-col gap-1 items-center w-10">
                            <span className="text-[10px] text-gray-400">Y</span>
                            <select 
                              className={`w-full p-1 border rounded text-center appearance-none cursor-pointer focus:ring-1 focus:ring-[#005A3C] focus:outline-none ${theme === 'dark' ? 'bg-gray-800 border-gray-600' : 'bg-white border-gray-300'} ${answersC_Y[item.id]?.group ? 'font-bold text-[#005A3C] border-[#005A3C]' : ''}`}
                              value={answersC_Y[item.id]?.group || ''}
                              onChange={(e) => updatePartC(item.id, 'Y', 'group', e.target.value)}
                            >
                              <option value=""></option>
                              {[1,2,3,4].map(n => <option key={n} value={n}>{n}</option>)}
                            </select>
                          </div>
                          <div className="flex flex-col gap-1 items-center w-10">
                            <span className="text-[10px] text-gray-400">T</span>
                            <select 
                              className={`w-full p-1 border rounded text-center appearance-none cursor-pointer focus:ring-1 focus:ring-[#005A3C] focus:outline-none ${theme === 'dark' ? 'bg-gray-800 border-gray-600' : 'bg-white border-gray-300'} ${answersC_T[item.id]?.group ? 'font-bold text-[#005A3C] border-[#005A3C]' : ''}`}
                              value={answersC_T[item.id]?.group || ''}
                              onChange={(e) => updatePartC(item.id, 'T', 'group', e.target.value)}
                            >
                              <option value=""></option>
                              {[1,2,3,4].map(n => <option key={n} value={n}>{n}</option>)}
                            </select>
                          </div>
                        </div>
                      </td>

                      {/* Best Usage Options */}
                      <td className="p-3 border-r dark:border-gray-700 align-top">
                        <div className="space-y-1">
                          {item.options.map(opt => (
                            <div key={opt.v} className="flex gap-2">
                              <span className="font-mono text-gray-400 select-none">{opt.v}.</span>
                              <span className={theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}>{opt.t}</span>
                            </div>
                          ))}
                        </div>
                      </td>

                      {/* Usage Selection Y */}
                      <td className="p-3 border-r dark:border-gray-700 align-middle text-center">
                        <select 
                          className={`w-12 p-1.5 border rounded text-center appearance-none cursor-pointer mx-auto block focus:ring-1 focus:ring-[#005A3C] focus:outline-none ${theme === 'dark' ? 'bg-gray-800 border-gray-600' : 'bg-white border-gray-300'} ${answersC_Y[item.id]?.usage ? 'font-bold text-[#005A3C] border-[#005A3C]' : ''}`}
                          value={answersC_Y[item.id]?.usage || ''}
                          onChange={(e) => updatePartC(item.id, 'Y', 'usage', e.target.value)}
                        >
                          <option value=""></option>
                          {item.options.map(o => <option key={o.v} value={o.v}>{o.v}</option>)}
                        </select>
                      </td>

                      {/* Usage Selection T */}
                      <td className="p-3 align-middle text-center">
                        <select 
                          className={`w-12 p-1.5 border rounded text-center appearance-none cursor-pointer mx-auto block focus:ring-1 focus:ring-[#005A3C] focus:outline-none ${theme === 'dark' ? 'bg-gray-800 border-gray-600' : 'bg-white border-gray-300'} ${answersC_T[item.id]?.usage ? 'font-bold text-[#005A3C] border-[#005A3C]' : ''}`}
                          value={answersC_T[item.id]?.usage || ''}
                          onChange={(e) => updatePartC(item.id, 'T', 'usage', e.target.value)}
                        >
                          <option value=""></option>
                          {item.options.map(o => <option key={o.v} value={o.v}>{o.v}</option>)}
                        </select>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </section>

          {/* Export CSV Section */}
          <section className="flex flex-col sm:flex-row gap-4 justify-center items-center pt-4 pb-2">
            <button 
              onClick={() => handleExportCSV('Y')}
              className={`flex items-center gap-2 px-6 py-3 rounded-lg font-medium shadow-sm transition-all hover:-translate-y-0.5 ${theme === 'dark' ? 'bg-gray-800 text-gray-200 border border-gray-700 hover:bg-gray-700' : 'bg-white text-gray-700 border border-gray-200 hover:bg-gray-50'}`}
            >
              <Download size={18} className="text-[#005A3C] dark:text-emerald-500" />
              {t.exportYouCsv}
            </button>
            <button 
              onClick={() => handleExportCSV('T')}
              className={`flex items-center gap-2 px-6 py-3 rounded-lg font-medium shadow-sm transition-all hover:-translate-y-0.5 ${theme === 'dark' ? 'bg-[#005A3C]/80 text-white hover:bg-[#005A3C]' : 'bg-[#005A3C] text-white hover:bg-emerald-800'}`}
            >
              <Download size={18} />
              {t.exportTeamCsv}
            </button>
          </section>

        </div>
      </main>

      {/* Footer */}
      <footer className={`py-8 px-6 mt-10 border-t ${theme === 'dark' ? 'bg-[#1e293b] text-gray-500 border-gray-800' : 'bg-gray-100 text-gray-400 border-gray-200'}`}>
        <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4 text-sm">
          <div className="text-center md:text-left">
            <p className="font-medium">{t.version}</p>
            <p className="mt-1 text-xs">{t.copyright}</p>
          </div>
          <div className="text-center md:text-right">
            <p>
              Architect: <a href="https://www.ibs.ncnu.edu.tw/index.php/faculty/tenured-professor/299-smlo" target="_blank" rel="noopener noreferrer" className="hover:text-[#005A3C] dark:hover:text-emerald-500 font-medium underline transition-colors">Prof. Shihmin Lo</a>
            </p>
            <p className="mt-1 text-xs">A professional strategic decision-making simulation tool.</p>
          </div>
        </div>
      </footer>
    </div>
  );
};

export default App;